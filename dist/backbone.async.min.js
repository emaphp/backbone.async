!function(a,b){"function"==typeof define&&define.amd?define(["backbone","underscore"],function(c,d){return b(a,c,d)}):"undefined"!=typeof exports?module.exports=b(a,require("backbone"),require("underscore")):b(a,a.Backbone,a._)}(this,function(a,b,c){var d=function(a,b,c){return function(d,e,f){a&&a.apply(d,arguments);var g={response:e,options:f};g[c.collection?"collection":"model"]=d,b(g),f.silent||d.trigger("after:"+c.method,d,e,f,c.success)}},e=function(a,b,d,e){var f,g;return"save"===a?null===b||"object"==typeof b?(f=b,g=d):b&&((f={})[b]=d,g=e):g=b,g=g?c.extend({},g):{},{attrs:f,options:g}},f=function(a){return function(c,f){return c[f]=function(c,g,h){var i=this,j=e(f,c,g,h),k=j.options,l=j.attrs,m=k.success,n=k.error,o=function(c){return{method:f,collection:a===b.Collection.prototype,success:c}};return new Promise(function(c,e){k.success=d(m,c,o(!0)),k.error=d(n,e,o(!1)),a===b.Collection.prototype?(k.silent||i.trigger("before:"+f,i,k),a[f].call(i,k)):(k.silent||("save"===f?i.trigger("before:save",i,l,k):i.trigger("before:"+f,i,k)),a[f].apply(i,"save"===f?[l,k]:[k]))})},c}},g=function(a,b){return b.reduce(f(a),{})},h=b.Async=b.Async||{};h.VERSION="1.3.0",h.extend=b.Model.extend,h.Model=b.Model.extend(g(b.Model.prototype,["fetch","save","destroy"])),h.Collection=b.Collection.extend(g(b.Collection.prototype,["fetch"]));var i=function(a,b,d,e){var f=b.success,g=b.error,h=b.complete,i=["after:"+d];return c.extend(b,{success:function(b,d,g){e&&e.apply(a,arguments),f&&f(b,d,g),i=i.concat(c.toArray(arguments),[!0])},error:function(a,b,d){g&&g(a,b,d),i=i.concat(c.toArray(arguments),[!1])},complete:function(b,c){var d=i[3];d.silent||a.trigger.apply(a,i),h&&h(b,c)}})};c.extend(h.Collection.prototype,{create:function(a,b){if(b=b?c.clone(b):{},b.silent||this.trigger("before:create",this,a,b),!(a=this._prepareModel(a,b)))return!1;b.wait||this.add(a,b);var d=function(a,b,c){c.wait&&this.add(a,c)};return a.save(null,i(this,b,"create",d))},update:function(a,b){b=b?c.clone(b):{},b.silent||this.trigger("before:update",a,b);var d=function(a,b,d){this.add(a,c.extend({merge:!0},d))};return a.save(null,i(this,b,"update",d))},"delete":function(a,b){return b=b?c.clone(b):{},b.silent||this.trigger("before:delete",a,b),a.destroy(i(this,b,"delete"))}});var j=h.Store=function(a){this.collectionClass||(this.collectionClass=h.Collection),this.collection=new this.collectionClass,this.modelClass?this.collection.model=this.modelClass:this.modelClass=this.collection.model?this.collection.model:this.collection.model=h.Model,this.options=a?c.clone(a):{},this.loaded=!1,this.initialize.apply(this,arguments)},k=function(a,b,d){var e=b.success;return c.extend(b,{success:function(b,c,f){d&&d.apply(a,arguments),e&&e(b,c,f)}})};c.extend(j.prototype,b.Events,{initialize:function(){},fetchAll:function(a){if(a=a||{},force=!!a.force,this.loaded&&!force)return Promise.resolve({collection:this.collection,options:a});var b=function(){this.loaded=!0};return this.collection.fetch(k(this,a,b))},fetchById:function(a,b){b=b||{};var c=this.collection.get(a);if(c)return Promise.resolve({model:c,options:b});var d=new this.modelClass;d.set(this.modelClass.idAttribute||"id",a);var e=function(){this.add(d)};return d.fetch(k(this,b,e))},length:function(){return this.collection?this.collection.length:void 0}});var l=["reset","get","add","remove","shift","pop","push","unshift","where","findWhere","toJSON","sort","create","update","delete"];return c.each(l,function(a){j.prototype[a]=function(){return this.collection[a].apply(this.collection,arguments)}}),j.extend=b.Model.extend,h});