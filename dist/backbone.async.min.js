!function(a,b){"function"==typeof define&&define.amd?define(["backbone","underscore"],function(c,d){return b(a,c,d)}):"undefined"!=typeof exports?module.exports=b(a,require("backbone"),require("underscore")):b(a,a.Backbone,a._)}(this,function(a,b,c){var d=function(a,b,c){return function(d,e,f){a&&a.apply(d,arguments);var g={response:e,options:f};g[c.collection?"collection":"model"]=d,b(g),"undefined"!=typeof f.silent&&f.silent||d.trigger("after:"+c.method,g,c.success)}},e=function(a,b,d,e){var f,g;return"save"===a?null===b||"object"==typeof b?(f=b,g=d):b&&((f={})[b]=d,g=e):g=b,g=g?c.extend({},g):{},{attrs:f,options:g}},f=function(a){return function(f,g){return f[g]=function(f,h,i){var j=this,k=e(g,f,h,i),l=k.options,m=k.attrs,n=l.success,o=l.error,p={method:g,collection:a===b.Collection.prototype};return new Promise(function(b,e){l.success=d(n,b,c.extend({success:!0},p)),l.error=d(o,e,c.extend({success:!1},p)),p.collection?("undefined"!=typeof l.silent&&l.silent||j.trigger("before:"+g,{collection:j,options:l}),a[g].call(j,l)):("undefined"!=typeof l.silent&&l.silent||j.trigger("before:"+g,"save"===g?{model:j,options:l,attrs:m}:{model:j,options:l}),a[g].apply(j,"save"===g?[m,l]:[l]))})},f}},g=function(a,b){return b.reduce(f(a.prototype),{})},h=b.Async=b.Async||{};h.VERSION="1.1.0",h.Model=b.Model.extend(g(b.Model,["fetch","save","destroy"])),h.Collection=b.Collection.extend(g(b.Collection,["fetch"]));var i=h.Storage=function(a){this.isLoaded=!1,a&&(a.Collection&&(this.Collection=a.Collection),a.Model?this.Model=a.Model:a.Collection&&a.Collection.model&&(this.Model=a.Collection.model)),i.prototype.initialize.apply(this,arguments)};return c.extend(i.prototype,b.Events,{initialize:function(){},fetch:function(a){if(this.isLoaded)return Promise.resolve({collection:this.collection,options:a});if(!this.Collection)throw new Error("No Collection class defined");a=a||{};var b=this,c="undefined"==typeof a.silent||!a.silent;return new Promise(function(d,e){b.collection||(b.collection=new b.Collection),c&&b.trigger("before:fetch",{collection:b.collection,options:a}),b.collection.fetch(a).then(function(a){c&&b.trigger("after:fetch",a,!0),b.isLoaded=!0,d(a)})["catch"](function(a){c&&b.trigger("after:fetch",a,!1),e(a)})})},get:function(a,b){if(this.collection){var c=this.collection.get(a);if(c)return Promise.resolve({model:c,options:b})}if(!this.Model)throw new Error("No Model class defined");if(!this.Collection)throw new Error("No Collection class defined");b=b||{};var d=this,e="undefined"==typeof b.silent||!b.silent;return new Promise(function(c,f){var g=new d.Model;g.set(d.Model.idAttribute||"id",a),e&&d.trigger("before:get",{model:g,options:b}),g.fetch(b).then(function(a){e&&d.trigger("after:get",a,!0),d.collection||(d.collection=new d.Collection),d.collection.push(g),d.listenTo(g,"after:destroy",function(a,b){b&&d.collection.remove(a.model,{silent:!0})}),c(a)})["catch"](function(a){e&&d.trigger("after:get",a,!1),f(a)})})}}),i.extend=b.Model.extend,h});