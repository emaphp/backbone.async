!function(a,b){"function"==typeof define&&define.amd?define(["backbone","underscore"],function(c,d){return b(a,c,d)}):"undefined"!=typeof exports?module.exports=b(a,require("backbone"),require("underscore")):b(a,a.Backbone,a._)}(this,function(a,b,c){var d=function(a,b,c){return function(d,e,f){a&&a.apply(d,arguments);var g={response:e,options:f};g[c.collection&&"create"!=c.method?"collection":"model"]=d,b(g),f.silent||d.trigger("after:"+c.method,d,e,f,c._success)}},e=function(a,b,d,e){var f,g;return"save"===a||"create"===a?null===b||"object"==typeof b?(f=b,g=d):b&&((f={})[b]=d,g=e):g=b,g=g?c.extend({},g):{},{attrs:f,options:g}},f=function(a){return function(f,g){return f[g]=function(f,h,i){var j=this,k=e(g,f,h,i),l=k.options,m=k.attrs,n=l.success,o=l.error,p={method:g,collection:a===b.Collection.prototype};return new Promise(function(b,e){l.success=d(n,b,c.extend({_success:!0},p)),l.error=d(o,e,c.extend({_success:!1},p)),p.collection?(l.silent||("create"===g?j.trigger("before:create",j,m,l):j.trigger("before:"+g,j,l)),a[g].apply(j,"create"===g?[m,l]:[l])):(l.silent||("save"===g?j.trigger("before:save",j,m,l):j.trigger("before:"+g,j,l)),a[g].apply(j,"save"===g?[m,l]:[l]))})},f}},g=function(a,b){return b.reduce(f(a.prototype),{})},h=b.Async=b.Async||{};h.VERSION="1.2.0",h.Model=b.Model.extend(g(b.Model,["fetch","save","destroy"])),h.Collection=b.Collection.extend(g(b.Collection,["fetch","create"]));var i=h.Storage=function(a){a&&(a.Collection&&(this.Collection=a.Collection),a.Model?this.Model=a.Model:a.Collection&&a.Collection.model&&(this.Model=a.Collection.model)),this.loaded=!1,this.initialize.apply(this,arguments)};return c.extend(i.prototype,b.Events,{initialize:function(){},fetchAll:function(a){if(this.loaded)return Promise.resolve({collection:this.collection,options:a});this._initCollection(),a=a||{};var b=this,d=!a.silent;return new Promise(function(e,f){d&&b.trigger("before:fetchAll",b.collection,a),b.collection.fetch(a).then(function(a){d&&b.trigger("after:fetchAll",a.collection,a.response,a.options,!0),b.loaded=!0,e(a)})["catch"](function(a){d&&(c.isError(a)?b.trigger("after:fetchAll",a,void 0,void 0,!1):b.trigger("after:fetchAll",a.collection,a.response,a.options,!1)),f(a)})})},fetch:function(a,b){if(this.collection){var d=this.collection.get(a);if(d)return Promise.resolve({model:d,options:b})}if(!this.Model)throw new Error("No Model class defined");this._initCollection(),b=b||{};var e=this,f=!b.silent;return new Promise(function(d,g){var h=new e.Model;h.set(e.Model.idAttribute||"id",a),f&&e.trigger("before:fetch",h,b),h.fetch(b).then(function(a){f&&e.trigger("after:fetch",a.model,a.response,a.options,!0),e.collection.add(h),e.listenToOnce(h,"after:destroy",function(a,b,d){d&&e.collection.remove(a,c.extend({silent:!0},b))}),d(a)})["catch"](function(a){f&&(c.isError(a)?e.trigger("after:fetch",a,void 0,void 0,!1):e.trigger("after:fetch",a.model,a.response,a.options,!1)),g(a)})})},store:function(a){this._initCollection(),this.collection.push(a),this.listenToOnce(a,"after:destroy",function(a,b,d,e){e&&this.collection.remove(a,c.extend({silent:!0},d))})},get:function(a){return this._initCollection(),this.collection.get(a)},create:function(a,b){if(!this.Model)throw new Error("No Model class defined");this._initCollection(),b=b||{};var d=this,e=!b.silent;return new Promise(function(f,g){e&&d.trigger("before:create",d.collection,a,b),d.collection.create(a,b).then(function(a){e&&d.trigger("after:create",a.model,a.response,a.options,!0),d.collection.add(a.model),d.listenToOnce(a.model,"after:destroy",function(a,b,e){e&&d.collection.remove(a,c.extend({silent:!0},b))}),f(a)})["catch"](function(a){e&&(c.isError(a)?d.trigger("after:create",a,void 0,void 0,!1):d.trigger("after:create",a.model,a.response,a.options,!1)),g(a)})})},_initCollection:function(){if(!this.Collection)throw new Error("No Collection class defined");this.collection||(this.collection=new this.Collection)}}),i.extend=b.Model.extend,h});
